{{- if .Values.applications }}
{{-   range .Values.applications }}
{{-     if .app }}
{{-       if eq .app.type "job"}}
{{-         $configMap        := .configMap }}
{{-         $name             := .name }}
{{-         $namespace        := $.Release.Namespace }}
{{-         $fullName         := include "universal-template.fullName" (list $ . $name) }}
{{-         $extraLabels      := .app.extraLabels }}
{{-         $replicas         := .app.replicas }}
{{-         $podAnnotations   := .app.podAnnotations }}
{{-         $image            := .app.image }}
{{-         $ports            := .app.ports }}
{{-         $envs             := .app.envs }}
{{-         $resources        := .app.resources }}
{{-         $persistentVolume := .app.persistentVolume }}
{{-         $tolerations      := .app.tolerations }}
{{-         $affinity         := .app.affinity }}
{{          $nodeSelector     := .app.nodeSelector }}
{{-         $probes           := .app.probes }}
{{-         $commands         := .app.commands }}
{{-         $args             := .app.args }}
{{-         $job              := .app.job }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $fullName }}-{{ now | unixEpoch }}
  namespace: {{ $namespace }}
  labels:
    {{- include "universal-template.labels" $ | nindent 4 }}
    {{- include "universal-template.selectorLabels" (list $fullName) | nindent 4 }}
spec:
  parallelism: {{ default 1 $job.parallelism }}
  completions: {{ default 1 $job.completions }}
  backoffLimit: {{ default 3 $job.backoffLimit }}
  activeDeadlineSeconds: {{ default 600 $job.activeDeadlineSeconds }}
  ttlSecondsAfterFinished: {{ default 300 $job.ttlSecondsAfterFinished }}
  template:
    spec:
      {{- if $affinity }}
      affinity:
      {{-   toYaml $affinity | nindent 8 }}
      {{- end }}
      {{- if $nodeSelector }}
      nodeSelector:
      {{-   toYaml $nodeSelector | nindent 8 }}
      {{- end }}
      {{- if $tolerations }}
      tolerations:
      {{-   toYaml $tolerations | nindent 8 }}
      {{- end }}
      containers:
      - name: {{ $fullName }}
        image: {{ $image.repository }}:{{ $image.tag }}
        imagePullPolicy: {{ $image.pullPolicy }}
        {{- if $resources }}
        resources: {{- toYaml $resources | nindent 10 }}
        {{- end }}
        {{- if $commands }}
        command:
        {{-   range $commands }}
          - {{ . | quote }}
        {{-   end }}
        {{- end }}
        {{- if $args }}
        args:
        {{-   range $args }}
          - {{ . | quote }}
        {{-   end }}
        {{- end }}
        {{- if $envs }}
        env:
        {{-   range $envs }}
          - name: {{ .name }}
        {{-     if .valueFrom }}
            valueFrom:
            secretKeyRef:
              name: {{ .valueFrom.secretKeyRef.name }}
              key: {{ .valueFrom.secretKeyRef.key }}
        {{-     else }}
            value: {{ .value }}
        {{-     end }}
        {{-   end }}
        {{- end }}
      {{- if $configMap }}
        volumeMounts:
        - name: volume-configs
          mountPath: {{ $configMap.mountPath | lower }}
          readOnly: true
      volumes:
      - name: volume-configs
        configMap:
          name: {{ $fullName }}
          items:
          {{-   range $configMap.files }}
          - key: {{ .name | lower }}
            path: {{ .name | lower }}
          {{-   end }}
      {{- end }}
      {{- if $image.pullSecrets }}
      imagePullSecrets:
      {{-   range $image.pullSecrets }}
        - name: {{ . }}
      {{-   end }}
      {{- end }}
      restartPolicy: {{ $job.restartPolicy | default "Never" }}
  backoffLimit: {{ $job.backoffLimit | default 1 }}
...
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}
